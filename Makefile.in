# This file is (c) 1998 Ted Faber (faber@lunabase.org) see COPYRIGHT
# for the full copyright and limitations of liabilities.

prefix = @prefix@
exec_prefix = @exec_prefix@

BINDIR = @bindir@
DEFINESDIR = @datadir@/grap
MANDIR = @mandir@/man1

INSTALL=@INSTALL@
INSTALL_PROGRAM=@INSTALL_PROGRAM@
INSTALL_DATA=@INSTALL_DATA@
RM=rm -f
RMDIR=rmdir
MKDIR=mkdir
LEX=@LEX@
YACC=@YACC@
CXX=@CXX@
LIBOBJS=@LIBOBJS@
PERL=@PERL@

DISTDIR=grap-1.20pre2
SOURCES=grap.cc grap_lex.cc *.cc

CXXFLAGS += @GXXFLAGS@ @DEFS@ 

# solaris make uses these as defaults:

CCC=$(CXX)
CCFLAGS=$(CXXFLAGS)

OBJS=grap.o grap_lex.o grap_draw.o grap_pic.o grap_parse.o version.o $(LIBOBJS)

all:	grap

.l.cc:
	$(LEX) -o$@ $<

grap:	$(OBJS)
	$(CXX) $(CXXFLAGS) $(LDFLAGS) $(OBJS) $(LDLIBS) -o grap
	if test -f grap.exe ; then mv -f grap.exe grap; fi

y.tab.h grap.cc:	grap.y
	$(YACC) -d grap.y
	mv y.tab.c grap.cc;

grap_lex.cc:	grap_lex.l y.tab.h


version.cc:	Makefile
	echo "#include <string>" > version.cc
	echo "using namespace std;" >> version.cc
	echo "string version=\"$(DISTDIR)\";" >> version.cc

y.output:	grap.y
	$(YACC) -v grap.y

grap.man:	grap.1
	groff -mdoc -Tascii grap.1 > grap.man

grap.ps:	grap.1
	groff -mdoc grap.1 > grap.ps

grap.1:	grap.doc
	perl -pe "s#DEFINES_FILE#$(DEFINESDIR)/grap.defines#g; s#EXAMPLES#$(DEFINESDIR)/examples#g;" < grap.doc > grap.1 ;\

dist:	
	cd examples && ${MAKE} clean
	${MAKE} veryclean
	${MAKE} grap.man
	${MAKE} grap.ps
	cd .. && tar cf - grap | (cd /tmp && tar xf -)
	cd /tmp && mv grap ${DISTDIR}
	${RM} /tmp/${DISTDIR}/configure.in /tmp/${DISTDIR}/Makefile \
		/tmp/${DISTDIR}/examples/Makefile /tmp/${DISTDIR}/.cvsignore \
		/tmp/${DISTDIR}/examples/.cvsignore 
	${RM} /tmp/${DISTDIR}/examples/Makefile.local \
		/tmp/${DISTDIR}/examples/color_example.ms
	${RM} /tmp/${DISTDIR}/examples/.html* /tmp/${DISTDIR}/examples/.cvsignore
	${RM} -r /tmp/${DISTDIR}/CVS /tmp/${DISTDIR}/examples/CVS
	${RM} -r /tmp/${DISTDIR}/examples/*.ps.gz /tmp/${DISTDIR}/examples/*.pdf 
	cd /tmp && tar czf ${DISTDIR}.tar.gz ${DISTDIR}
	mv /tmp/${DISTDIR}.tar.gz . && ${RM} -rf /tmp/${DISTDIR}

clean:
	${RM} grap $(OBJS) grap_lex.cc grap.cc  *.o y.tab.h grap.1 grap.man grap.ps ${DISTDIR}.tar.gz *core* y.output depend

veryclean:
	${MAKE} clean
	${RM} config.log config.status config.cache config.h version.cc *.tgz

spotless:
	${MAKE} veryclean
	${RM} configure

# The || true lines allow make to continue on systems where install -d
# fails on existing directories.
install:	grap grap.defines grap.1
	strip grap
	$(INSTALL) -d $(BINDIR) || true
	$(INSTALL) -d $(MANDIR) || true
	$(INSTALL) -d $(DEFINESDIR)/examples || true
	$(INSTALL_PROGRAM) grap $(BINDIR)
	$(INSTALL_DATA) grap.1 $(MANDIR)
	$(INSTALL_DATA) grap*.defines $(DEFINESDIR)
	$(INSTALL_DATA) README $(DEFINESDIR)
	$(INSTALL_DATA) CHANGES $(DEFINESDIR)
	$(INSTALL_DATA) COPYRIGHT $(DEFINESDIR)
	$(INSTALL_DATA) grap.man $(DEFINESDIR)
	$(INSTALL_DATA) examples/*.d examples/example.ms examples/*.result examples/Makefile $(DEFINESDIR)/examples

deinstall:
	$(RM) $(BINDIR)/grap
	$(RM) $(MANDIR)/grap.1
	$(RM) $(DEFINESDIR)/grap.defines $(DEFINESDIR)/README $(DEFINESDIR)/CHANGES $(DEFINESDIR)/COPYRIGHT $(DEFINESDIR)/grap.man
	$(RM) $(DEFINESDIR)/examples/*.d $(DEFINESDIR)/examples/*.ms $(DEFINESDIR)/examples/Makefile $(DEFINESDIR)/examples/*result
	$(RMDIR) $(DEFINESDIR)/examples
	$(RMDIR) $(DEFINESDIR)

cleandepend:
	${PERL} -i -ne 'print if 1 .. /^\# End of Makefile/;' Makefile

depend:	${SOURCES}
	${MAKE} cleandepend
	@MAKEDEP@
	touch depend

# Some of the standard GNU targets to make some people's lives easier

mostlyclean:	clean
distclean:	veryclean
	rm Makefile
maintainer-clean:	veryclean
check:

# End of Makefile
